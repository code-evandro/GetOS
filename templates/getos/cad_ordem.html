{% extends "getos/base.html" %}
{% load static %}

{% block title %}Abrir Ordem de Serviço - GetOS{% endblock %}
{% block nav_abrir_os_active %}active{% endblock %}

{% block content %}

<div class="card-dark mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <div class="page-title">Abrir Ordem de Serviço</div>
            <div class="page-subtitle">
                Preencha os dados abaixo para registrar uma nova OS.
            </div>
        </div>
    </div>
</div>

<div class="card-dark">
    {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
                <div class="feedback">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="POST" class="row g-3">
        {% csrf_token %}

        <!-- Servidor -->
        <div class="col-md-6">
            <label for="id_servidor" class="form-label">Servidor</label>
            {{ form.servidor }}
            {{ form.servidor.errors }}
        </div>

        <!-- Setor (somente leitura, preenchido via JS) -->
        <div class="col-md-3">
            <label for="setor_display" class="form-label">Setor</label>
            <input type="text" id="setor_display" class="form-input" readonly>
        </div>

        <!-- Ramal (somente leitura, preenchido via JS) -->
        <div class="col-md-3">
            <label for="ramal_display" class="form-label">Ramal</label>
            <input type="text" id="ramal_display" class="form-input" readonly>
        </div>

        <!-- Tipo -->
        <div class="col-md-4">
            <label for="id_tipo" class="form-label">Tipo</label>
            {{ form.tipo }}
            {{ form.tipo.errors }}
        </div>

        <!-- Técnico -->
        <div class="col-md-4">
            <label for="id_tecnico" class="form-label">Técnico</label>
            {{ form.tecnico }}
            {{ form.tecnico.errors }}
        </div>

        <!-- Data -->
        <div class="col-md-4">
            <label for="id_data" class="form-label">Data</label>
            {{ form.data }}
            {{ form.data.errors }}
        </div>

        <!-- Relato -->
        <div class="col-12">
            <label for="id_relato" class="form-label">Relato</label>
            {{ form.relato }}
            {{ form.relato.errors }}
        </div>

        <div class="col-12 mt-2">
            <button type="submit" class="btn-accent w-100">
                Salvar Ordem
            </button>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const servidorDados = {
        {% for servidor in form.fields.servidor.queryset %}
            "{{ servidor.id }}": {
                "setor": "{{ servidor.setor.nome|escapejs }}",
                "ramal": "{{ servidor.setor.ramal|escapejs }}"
            },
        {% endfor %}
    };

    const servidorSelect = document.getElementById("id_servidor");
    const setorDisplay = document.getElementById("setor_display");
    const ramalDisplay = document.getElementById("ramal_display");

    function atualizarCampos() {
        const dados = servidorDados[servidorSelect.value];
        if (dados) {
            setorDisplay.value = dados.setor;
            ramalDisplay.value = dados.ramal;
        } else {
            setorDisplay.value = "";
            ramalDisplay.value = "";
        }
    }

    if (servidorSelect) {
        servidorSelect.addEventListener("change", atualizarCampos);
        window.addEventListener("load", atualizarCampos);
    }
</script>
{% endblock %}
